<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard | HGS</title>
    <style>
        /* --- General Setup --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            min-height: 100vh;
        }

        .primary-green { background-color: #2ecc71; }
        .text-primary-green { color: #2ecc71; }
        .dark-blue { background-color: #34495e; }

        /* --- Sidebar Navigation --- */
        .sidebar {
            width: 250px; 
            background-color: #2c3e50;
            color: white;
            padding-top: 20px;
            position: fixed;
            height: 100%;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        #myVideo {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -11;
    pointer-events: none;
}

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 25px;
            color: #2ecc71;
            font-weight: bold;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar a {
            display: block;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            font-size: 15px;
        }

        .sidebar a svg {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            fill: white;
        }
        
        .sidebar a:hover, .sidebar a.active {
            background-color: #65bc2738;
            color: #2ecc71;
        }

        /* --- Main Content Area --- */
        .main-content {
            margin-left: 250px; 
            flex-grow: 1;
            padding: 20px;
        }

        /* --- Header --- */
        .header {
            background-color: white;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .header h1 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
        }
        .logout-btn { display:inline-block; padding:8px 12px; border-radius:6px; color:#666; text-decoration:none; border:1px solid #ddd; background:transparent; }
        .logout-btn:hover{ background:#2ecc71; color:#fff; border-color:#2ecc71; }
        
        /* --- Widgets (KPIs) --- */
        .widgets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .widget {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .widget-content h3 {
            margin: 0 0 5px 0;
            font-size: 15px;
            color: #777;
        }

        .widget-content p {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }
        
        /* --- Grievance Table --- */
        .task-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        /* Toolbar (admin-like) */
        .toolbar {
            display:flex;
            gap:10px;
            align-items:center;
            margin: 12px 0 18px 0;
            flex-wrap:wrap;
        }
        .toolbar .search {
            flex:1;
            display:flex;
            gap:8px;
            align-items:center;
        }
        .toolbar input, .toolbar select { padding:8px 10px; border-radius:8px; border:1px solid #ddd; }
        .small-btn { padding:6px 10px; border-radius:8px; border:none; cursor:pointer; }
        .small-btn.gray { background:#eef0f2; color:#333; border:1px solid #ddd; }

        .grievance-table {
            width: 100%;
            border-collapse: collapse;
        }

        .grievance-table th, .grievance-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .grievance-table th {
            background-color: #f8f8f8;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            font-size: 12px;
        }

        .status-tag {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            display: inline-block;
        }

        .status-pending { background-color: #f39c12; }
        .status-in-review { background-color: #3498db; }
        .status-investigating { background-color: #9b59b6; }
        .status-resolved { background-color: #2ecc71; }
        .status-closed { background: #ff0000; }
        
        .action-button {
            padding: 6px 10px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* --- Modal for Resolution (S-03, S-04, S-05) --- */
        .modal {
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            z-index: 1000;
        }
        .modal-content {
            background: white; 
            width: 90%; 
            max-width: 700px; 
            margin: 50px auto; 
            padding: 30px; 
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .modal-content textarea, .modal-content select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .modal-content label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
        }
        
        /* ================= RESPONSIVE UPGRADE ================= */

/* Tablets */
@media (max-width: 1024px) {
    .sidebar {
        width: 180px;
    }
    .main-content {
        margin-left: 180px;
        padding: 16px;
    }
    .header h1 {
        font-size: 20px;
    }
    .widget-content p {
        font-size: 24px;
    }
}

/* Mobile & Small Tablets */
@media (max-width: 768px) {

    body {
        flex-direction: column;
    }

    .sidebar {
        position: relative;
        width: 100%;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: space-around;
        padding: 10px 0;
    }

    .sidebar h2 {
        margin: 0;
        font-size: 16px;
    }

    .sidebar ul {
        display: flex;
        gap: 10px;
    }

    .sidebar li {
        list-style: none;
    }

    .sidebar a {
        padding: 8px 10px;
        font-size: 13px;
    }

    .sidebar a svg {
        width: 14px;
        height: 14px;
        margin-right: 6px;
    }

    .main-content {
        margin-left: 0;
        padding: 12px;
    }

    .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }

    .widgets-grid {
        grid-template-columns: 1fr;
        gap: 14px;
    }

    .toolbar {
        flex-direction: column;
        align-items: stretch;
    }

    .toolbar .search {
        flex-direction: column;
        width: 100%;
    }

    .grievance-table th,
    .grievance-table td {
        font-size: 12px;
        padding: 8px;
    }

    .task-section {
        padding: 14px;
    }
}

/* ================= STAFF DASHBOARD TABLE RESPONSIVE ================= */

/* Tablets */
@media (max-width: 900px) {
    .grievance-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }
}

/* Mobile */
@media (max-width: 700px) {
    .grievance-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }
}

/* Small phones */
@media (max-width: 420px) {
    .grievance-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }
}


/* Very Small Phones */
@media (max-width: 420px) {

    .sidebar ul {
        flex-wrap: wrap;
        justify-content: center;
    }

    .sidebar a span {
        display: none; /* icons only on very small screens */
    }

    .header h1 {
        font-size: 18px;
    }

    .widget-content p {
        font-size: 22px;
    }

    .modal-content {
        padding: 20px;
    }
}

    </style>
</head>
<body>

    <div class="sidebar">
        <h2>HGS Staff</h2>
        <video autoplay muted loop playsinline preload="auto" id="myVideo">
        <source src="login bg video.mp4" type="video/mp4">
    </video>
        <ul>
            <li>
                <a href="#" class="active">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                    <span>Dashboard</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
                    <span>My Cases</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg>
                    <span>Alerts</span>
                </a>
            </li>
        </ul>
    </div>

    <script src="auth.js"></script>

    <div class="main-content">
        
        <div class="header">
            <h1>Staff Dashboard</h1>
            <div style="font-size: 14px; display:flex; align-items:center; gap:12px;">
                <span>Welcome, Jane Doe (Staff)</span>
                <a href="home.html" class="logout-btn">Logout</a>
            </div>
        </div>

        <div class="widgets-grid">
            
            <div class="widget" style="border-left: 5px solid #f39c12;">
                <div class="widget-content">
                    <h3>Pending Cases</h3>
                    <p><span id="stat-pending-cases">0</span></p>
                </div>
            </div>

            <div class="widget" style="border-left: 5px solid #2ecc71;">
                <div class="widget-content">
                    <h3>Resolved This Month</h3>
                    <p><span id="stat-resolved-month">0</span></p>
                </div>
            </div>

            <div class="widget" style="border-left: 5px solid #e74c3c;">
                <div class="widget-content">
                    <h3>Due This Week</h3>
                    <p style="color: #e74c3c;"><span id="stat-due-week">0</span></p>
                </div>
            </div>
        </div>

        <div class="task-section">
            <h2>My Active Grievance Queue</h2>
            <div class="toolbar">
                <div class="search">
                    <input id="staff-search" type="search" placeholder="Search by id, subject or category...">
                    <select id="staff-status-filter">
                        <option value="">All Statuses</option>
                        <option value="PENDING">Pending</option>
                        <option value="IN_REVIEW">In Review</option>
                        <option value="INVESTIGATING">Investigating</option>
                        <option value="RESOLVED">Resolved</option>
                        <option value="CLOSED">Closed</option>
                    </select>
                </div>
                <div class="actions">
                    <button id="staff-refresh" class="small-btn gray">Refresh</button>
                </div>
            </div>
            <table class="grievance-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Subject</th>
                        <th>Category</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Due Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="staff-grievance-list">
                    </tbody>
            </table>
        </div>

    </div>

    <div id="resolution-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-primary-green" style="margin-top: 0;">Resolve Grievance: <span id="modal-grievance-id"></span></h2>
            
            <p><strong>Subject:</strong> <span id="modal-grievance-subject"></span></p>
            <p><strong>Details:</strong> <span id="modal-grievance-details"></span></p>
            <hr>

            <div id="modal-images" style="display:flex; gap:8px; margin:12px 0; flex-wrap:wrap;"></div>

            <label for="new-status">Update Status:</label>
            <select id="new-status">
                <option value="PENDING">Pending</option>
                <option value="IN_REVIEW">In Review</option>
                <option value="INVESTIGATING">Investigating</option>
                <option value="RESOLVED">Resolved</option>
                
            </select>
            
            <label for="internal-notes">Internal Investigation Notes (S-03):</label>
            <textarea id="internal-notes" rows="4" placeholder="Document all steps taken, evidence gathered, and internal actions. (Visible only to Staff/Admin)"></textarea>

            <div id="resolution-summary-area" style="display: none;">
                <label for="resolution-summary">Public Resolution Summary (S-05):</label>
                <textarea id="resolution-summary" rows="4" placeholder="This summary will be visible to the reporter (Patient) to confirm the resolution."></textarea>
            </div>
            
            <button onclick="submitResolution()" class="action-button primary-green" style="margin-right: 10px;">Save & Update Status</button>
            <button onclick="closeModal()" class="action-button dark-blue">Cancel</button>

        </div>
    </div>


    <script>
        // backend-driven cases
        let staffCases = [];

        let currentCaseId = null;

        // --- Core Functions ---
        
        const renderCaseList = () => {
            const listBody = document.getElementById('staff-grievance-list');
            if (!listBody) { console.warn('renderCaseList: #staff-grievance-list not found'); return; }
            listBody.innerHTML = '';
            const q = (document.getElementById('staff-search')?.value || '').toLowerCase().trim();
            const statusFilter = (document.getElementById('staff-status-filter')?.value || '').toUpperCase();

            const filtered = staffCases.filter(g => {
                const matchesQuery = !q || (''+g.id).includes(q) || (g.title||'').toLowerCase().includes(q) || (g.category||'').toLowerCase().includes(q) || (g.details||'').toLowerCase().includes(q);
                const matchesStatus = !statusFilter || (g.status||'').toString().toUpperCase() === statusFilter;
                return matchesQuery && matchesStatus;
            });

            filtered.forEach(g => {
                const raw = (g.status || '').toString().toUpperCase();
                const statusClass = raw.toLowerCase().replace(/_/g, '-').replace(' ', '-');
                const displayStatus = raw === 'IN_REVIEW' ? 'In Review' : raw === 'INVESTIGATING' ? 'Investigating' : raw === 'RESOLVED' ? 'Resolved' : raw === 'CLOSED' ? 'Closed' : raw === 'PENDING' ? 'Pending' : raw;
                const row = listBody.insertRow();
                let dueDateText = g.dueDate;
                if (raw !== 'RESOLVED' && raw !== 'CLOSED' && g.dueDate && new Date(g.dueDate) < new Date()) {
                    dueDateText = `<span style="color: red; font-weight: bold;">${g.dueDate} (OVERDUE)</span>`;
                }

                row.innerHTML = `
                    <td>${g.id}</td>
                    <td>${g.title || g.subject || ''} ${g.images && g.images.length ? `<div style="font-size:12px;color:#666; margin-top:6px;">Images: ${g.images.length}</div>` : ''}</td>
                    <td>${g.category || ''}</td>
                    <td>${g.priority || ''}</td>
                    <td><span class="status-tag status-${statusClass}">${displayStatus}</span></td>
                        <td>${dueDateText || ''}</td>
                        <td>
                            ${raw === 'CLOSED' ? (g.feedback ? `<div style="font-size:13px;color:#333;">${(g.feedback.length>100? g.feedback.substring(0,100)+'...': g.feedback)}</div>` : '<div style="color:#777;">No feedback</div>') : `<button onclick="openResolutionModal(${g.id})" class="action-button">Resolve Case</button>`}
                        </td>
                `;
            });
        };

        async function loadStaffCases() {
            try {
                const res = await authFetch('http://localhost:8080/api/grievances');
                if (!res.ok) {
                    const t = await res.text().catch(()=>null);
                    console.error('loadStaffCases: fetch failed', res.status, t);
                    throw new Error('Failed to fetch: '+res.status);
                }
                const data = await res.json();
                console.log('loadStaffCases: fetched', data && data.length ? data.length + ' grievances' : 'no grievances', data && data[0] ? { sample: data[0], sampleImages: (data[0].images || []).slice(0,3)} : null);
                // map to UI shape
                // map to UI shape and compute a due date (createdAt + 7 days) for SLA
                staffCases = data.map(g => {
                    const created = g.createdAt ? new Date(g.createdAt) : null;
                    let due = '';
                    if (created) {
                        const d = new Date(created.getTime());
                        d.setDate(d.getDate() + 7);
                        due = d.toISOString().split('T')[0];
                    }
                    return {
                        id: g.id,
                        title: g.title,
                        category: g.category,
                        status: (g.status || 'PENDING').toString().toUpperCase(),
                        details: g.description || '',
                        createdAt: g.createdAt || '',
                        dueDate: due,
                        feedback: g.feedback || null,
                        images: g.images || []
                    };
                });

                // populate widget stats
                try {
                    const now = new Date();
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay()); // Sunday
                    startOfWeek.setHours(0,0,0,0);
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    endOfWeek.setHours(23,59,59,999);

                    const pendingCount = staffCases.filter(x => (x.status||'').toUpperCase() === 'PENDING').length;
                    const resolvedMonthCount = staffCases.filter(x => {
                        if ((x.status||'').toUpperCase() !== 'RESOLVED') return false;
                        if (!x.createdAt) return false;
                        const parts = x.createdAt.split('T')[0].split('-');
                        if (parts.length < 2) return false;
                        const y = parseInt(parts[0],10), m = parseInt(parts[1],10);
                        const nowD = new Date();
                        return y === nowD.getFullYear() && m === nowD.getMonth()+1;
                    }).length;

                    const dueThisWeek = staffCases.filter(x => {
                        if (!x.dueDate) return false;
                        const d = new Date(x.dueDate + 'T00:00:00');
                        if (d < startOfWeek || d > endOfWeek) return false;
                        const s = (x.status||'').toUpperCase();
                        return s !== 'RESOLVED' && s !== 'CLOSED';
                    }).length;

                    const el = id => document.getElementById(id);
                    if (el('stat-pending-cases')) el('stat-pending-cases').textContent = pendingCount;
                    if (el('stat-resolved-month')) el('stat-resolved-month').textContent = resolvedMonthCount;
                    if (el('stat-due-week')) el('stat-due-week').textContent = dueThisWeek;
                } catch(e) { console.warn('stats compute error', e); }

                renderCaseList();
            } catch (e) {
                console.error('loadStaffCases error', e);
            }
        }

        // --- Modal Functions (S-03, S-04, S-05) ---

        const openResolutionModal = (id) => {
            const caseData = staffCases.find(c => c.id === id);
            if (!caseData) return;

            currentCaseId = id;
            document.getElementById('modal-grievance-id').textContent = id;
            document.getElementById('modal-grievance-subject').textContent = caseData.title || caseData.subject || '';
            document.getElementById('modal-grievance-details').textContent = caseData.details;
            
            // Set initial status in the dropdown (status codes are uppercase)
            const ns = document.getElementById('new-status');
            ns.value = (caseData.status || 'PENDING').toString().toUpperCase();

            // Show/Hide Public Resolution Summary based on selected status
            const statusSelect = document.getElementById('new-status');
            const summaryArea = document.getElementById('resolution-summary-area');

            statusSelect.onchange = function() {
                summaryArea.style.display = (this.value === 'RESOLVED' || this.value === 'CLOSED') ? 'block' : 'none';
            };
            // Trigger the change handler once on load
            statusSelect.onchange(); 

            // render images if present
            const imgContainer = document.getElementById('modal-images');
            if (imgContainer) imgContainer.innerHTML = '';
            if (caseData.images && caseData.images.length) {
                caseData.images.forEach(src => {
                    const tn = document.createElement('div'); tn.style.width='120px'; tn.style.height='80px'; tn.style.overflow='hidden'; tn.style.border='1px solid #eee'; tn.style.borderRadius='6px'; tn.style.cursor='pointer';
                    const im = document.createElement('img'); im.src = src; im.style.width='100%'; im.style.height='100%'; im.style.objectFit='cover';
                    tn.appendChild(im);
                    tn.addEventListener('click', ()=> window.open(src));
                    imgContainer.appendChild(tn);
                });
            }

            document.getElementById('resolution-modal').style.display = 'block';
        };

        const closeModal = () => {
            document.getElementById('resolution-modal').style.display = 'none';
            document.getElementById('internal-notes').value = '';
            document.getElementById('resolution-summary').value = '';
            currentCaseId = null;
        };

        const submitResolution = async () => {
            if (!currentCaseId) return;

            const newStatus = document.getElementById('new-status').value;
            const internalNotes = document.getElementById('internal-notes').value;
            let resolutionSummary = document.getElementById('resolution-summary').value;
            
            const caseIndex = staffCases.findIndex(c => c.id === currentCaseId);

            if ((newStatus === 'RESOLVED' || newStatus === 'CLOSED') && resolutionSummary.trim() === '') {
                alert('A public resolution summary is REQUIRED when marking a case as Resolved/Closed.');
                return;
            }

            // Call backend to update status
            try {
                const res = await authFetch('http://localhost:8080/api/grievances/' + currentCaseId + '/status?status=' + encodeURIComponent(newStatus), { method: 'PUT' });
                if (!res.ok) {
                    const txt = await res.text().catch(()=>null);
                    throw new Error('Update failed: ' + res.status + ' ' + txt);
                }
                alert(`Case ${currentCaseId} updated to: ${newStatus}`);
                closeModal();
                await loadStaffCases();
            } catch (e) {
                console.error(e);
                alert('Failed to update status: ' + e.message);
            }
        };

        // debounce helper
        function debounce(fn, wait){ let t; return function(...args){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); }; }

        // Initial load + wire toolbar events
        document.addEventListener('DOMContentLoaded', () => {
            loadStaffCases();
            const si = document.getElementById('staff-search'); if (si) si.addEventListener('input', debounce(renderCaseList, 250));
            const sf = document.getElementById('staff-status-filter'); if (sf) sf.addEventListener('change', renderCaseList);
            const rf = document.getElementById('staff-refresh'); if (rf) rf.addEventListener('click', loadStaffCases);
        });
    </script>
</body>
</html>