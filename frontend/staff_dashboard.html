<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard | HGS</title>
    <style>
        /* --- General Setup --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            min-height: 100vh;
        }

        .primary-green { background-color: #2ecc71; }
        .text-primary-green { color: #2ecc71; }
        .dark-blue { background-color: #34495e; }

        /* --- Sidebar Navigation --- */
        .sidebar {
            width: 200px; /* Slightly narrower than Admin for simplicity */
            background-color: #2c3e50;
            color: white;
            padding-top: 20px;
            position: fixed;
            height: 100%;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 20px;
            color: #2ecc71;
            font-weight: bold;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar a {
            display: block;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            font-size: 15px;
        }

        .sidebar a svg {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            fill: white;
        }
        
        .sidebar a:hover, .sidebar a.active {
            background-color: #34495e;
            color: #2ecc71;
        }

        /* --- Main Content Area --- */
        .main-content {
            margin-left: 200px; 
            flex-grow: 1;
            padding: 20px;
        }

        /* --- Header --- */
        .header {
            background-color: white;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .header h1 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
        }
        
        /* --- Widgets (KPIs) --- */
        .widgets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .widget {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .widget-content h3 {
            margin: 0 0 5px 0;
            font-size: 15px;
            color: #777;
        }

        .widget-content p {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }
        
        /* --- Grievance Table --- */
        .task-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .grievance-table {
            width: 100%;
            border-collapse: collapse;
        }

        .grievance-table th, .grievance-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .grievance-table th {
            background-color: #f8f8f8;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            font-size: 12px;
        }

        .status-tag {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            display: inline-block;
        }

        .status-pending { background-color: #f39c12; }
        .status-in-review { background-color: #3498db; }
        .status-investigating { background-color: #9b59b6; }
        .status-resolved { background-color: #2ecc71; }
        
        .action-button {
            padding: 6px 10px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* --- Modal for Resolution (S-03, S-04, S-05) --- */
        .modal {
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            z-index: 1000;
        }
        .modal-content {
            background: white; 
            width: 90%; 
            max-width: 700px; 
            margin: 50px auto; 
            padding: 30px; 
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .modal-content textarea, .modal-content select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .modal-content label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
        }
        
        @media (max-width: 600px) {
            .sidebar { width: 100%; height: auto; position: relative; }
            .main-content { margin-left: 0; padding-top: 0; }
            .widgets-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>HGS Staff</h2>
        <ul>
            <li>
                <a href="#" class="active">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                    <span>Dashboard</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
                    <span>My Cases</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg>
                    <span>Alerts</span>
                </a>
            </li>
        </ul>
    </div>

    <script src="auth.js"></script>

    <div class="main-content">
        
        <div class="header">
            <h1>Staff Dashboard</h1>
            <div style="font-size: 14px;">
                <span>Welcome, Jane Doe (Staff)</span>
                <a href="home.html" style="color: #666; text-decoration: none; margin-left: 15px;">Logout</a>
            </div>
        </div>

        <div class="widgets-grid">
            
            <div class="widget" style="border-left: 5px solid #f39c12;">
                <div class="widget-content">
                    <h3>Pending Cases</h3>
                    <p>12</p>
                </div>
            </div>

            <div class="widget" style="border-left: 5px solid #2ecc71;">
                <div class="widget-content">
                    <h3>Resolved This Month</h3>
                    <p>38</p>
                </div>
            </div>

            <div class="widget" style="border-left: 5px solid #e74c3c;">
                <div class="widget-content">
                    <h3>Due This Week</h3>
                    <p style="color: #e74c3c;">4</p>
                </div>
            </div>
        </div>

        <div class="task-section">
            <h2>My Active Grievance Queue</h2>
            <table class="grievance-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Subject</th>
                        <th>Category</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Due Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="staff-grievance-list">
                    </tbody>
            </table>
        </div>

    </div>

    <div id="resolution-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-primary-green" style="margin-top: 0;">Resolve Grievance: <span id="modal-grievance-id"></span></h2>
            
            <p><strong>Subject:</strong> <span id="modal-grievance-subject"></span></p>
            <p><strong>Details:</strong> <span id="modal-grievance-details"></span></p>
            <hr>

            <label for="new-status">Update Status:</label>
            <select id="new-status">
                <option value="PENDING">Pending</option>
                <option value="IN_REVIEW">In Review</option>
                <option value="INVESTIGATING">Investigating</option>
                <option value="RESOLVED">Resolved</option>
                
            </select>
            
            <label for="internal-notes">Internal Investigation Notes (S-03):</label>
            <textarea id="internal-notes" rows="4" placeholder="Document all steps taken, evidence gathered, and internal actions. (Visible only to Staff/Admin)"></textarea>

            <div id="resolution-summary-area" style="display: none;">
                <label for="resolution-summary">Public Resolution Summary (S-05):</label>
                <textarea id="resolution-summary" rows="4" placeholder="This summary will be visible to the reporter (Patient) to confirm the resolution."></textarea>
            </div>
            
            <button onclick="submitResolution()" class="action-button primary-green" style="margin-right: 10px;">Save & Update Status</button>
            <button onclick="closeModal()" class="action-button dark-blue">Cancel</button>

        </div>
    </div>


    <script>
        // backend-driven cases
        let staffCases = [];

        let currentCaseId = null;

        // --- Core Functions ---
        
        const renderCaseList = () => {
            const listBody = document.getElementById('staff-grievance-list');
            listBody.innerHTML = '';
            
            staffCases.forEach(g => {
                // normalize status for CSS class and display
                const raw = (g.status || '').toString().toUpperCase();
                const statusClass = raw.toLowerCase().replace(/_/g, '-').replace(' ', '-');
                const displayStatus = raw === 'IN_REVIEW' ? 'In Review' : raw === 'INVESTIGATING' ? 'Investigating' : raw === 'RESOLVED' ? 'Resolved' : raw === 'COMPLETED' ? 'Completed' : raw === 'PENDING' ? 'Pending' : raw;
                const row = listBody.insertRow();
                
                let dueDateText = g.dueDate;
                // use normalized raw status for checks
                if (raw !== 'RESOLVED' && raw !== 'COMPLETED' && new Date(g.dueDate) < new Date()) {
                    dueDateText = `<span style="color: red; font-weight: bold;">${g.dueDate} (OVERDUE)</span>`;
                }

                row.innerHTML = `
                    <td>${g.id}</td>
                    <td>${g.title || g.subject || ''}</td>
                    <td>${g.category || ''}</td>
                    <td>${g.priority || ''}</td>
                    <td><span class="status-tag status-${statusClass}">${displayStatus}</span></td>
                    <td>${dueDateText || ''}</td>
                    <td>
                        <button onclick="openResolutionModal(${g.id})" class="action-button">Resolve Case</button>
                    </td>
                `;
            });
        };

        async function loadStaffCases() {
            try {
                const res = await authFetch('http://localhost:8080/api/grievances');
                if (!res.ok) throw new Error('Failed to fetch');
                const data = await res.json();
                // map to UI shape
                staffCases = data.map(g => ({
                    id: g.id,
                        title: g.title,
                        category: g.category,
                        status: (g.status || 'PENDING').toString().toUpperCase(),
                        details: g.description || '',
                        dueDate: g.createdAt ? g.createdAt.split('T')[0] : ''
                }));
                renderCaseList();
            } catch (e) {
                console.error('loadStaffCases error', e);
            }
        }

        // --- Modal Functions (S-03, S-04, S-05) ---

        const openResolutionModal = (id) => {
            const caseData = staffCases.find(c => c.id === id);
            if (!caseData) return;

            currentCaseId = id;
            document.getElementById('modal-grievance-id').textContent = id;
            document.getElementById('modal-grievance-subject').textContent = caseData.title || caseData.subject || '';
            document.getElementById('modal-grievance-details').textContent = caseData.details;
            
            // Set initial status in the dropdown (status codes are uppercase)
            const ns = document.getElementById('new-status');
            ns.value = (caseData.status || 'PENDING').toString().toUpperCase();

            // Show/Hide Public Resolution Summary based on selected status
            const statusSelect = document.getElementById('new-status');
            const summaryArea = document.getElementById('resolution-summary-area');

            statusSelect.onchange = function() {
                summaryArea.style.display = (this.value === 'RESOLVED' || this.value === 'COMPLETED') ? 'block' : 'none';
            };
            // Trigger the change handler once on load
            statusSelect.onchange(); 

            document.getElementById('resolution-modal').style.display = 'block';
        };

        const closeModal = () => {
            document.getElementById('resolution-modal').style.display = 'none';
            document.getElementById('internal-notes').value = '';
            document.getElementById('resolution-summary').value = '';
            currentCaseId = null;
        };

        const submitResolution = async () => {
            if (!currentCaseId) return;

            const newStatus = document.getElementById('new-status').value;
            const internalNotes = document.getElementById('internal-notes').value;
            let resolutionSummary = document.getElementById('resolution-summary').value;
            
            const caseIndex = staffCases.findIndex(c => c.id === currentCaseId);

            if ((newStatus === 'RESOLVED' || newStatus === 'COMPLETED') && resolutionSummary.trim() === '') {
                alert('A public resolution summary is REQUIRED when marking a case as Resolved/Completed.');
                return;
            }

            // Call backend to update status
            try {
                const res = await authFetch('http://localhost:8080/api/grievances/' + currentCaseId + '/status?status=' + encodeURIComponent(newStatus), { method: 'PUT' });
                if (!res.ok) {
                    const txt = await res.text().catch(()=>null);
                    throw new Error('Update failed: ' + res.status + ' ' + txt);
                }
                alert(`Case ${currentCaseId} updated to: ${newStatus}`);
                closeModal();
                await loadStaffCases();
            } catch (e) {
                console.error(e);
                alert('Failed to update status: ' + e.message);
            }
        };

        // Initial load
        document.addEventListener('DOMContentLoaded', () => { loadStaffCases(); });
    </script>
</body>
</html>